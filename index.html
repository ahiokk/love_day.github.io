<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LOVE DAY - Валентинка для Маши</title>
    <style>
      :root {
        --bg-1: #fff2f5;
        --bg-2: #ffe8da;
        --bg-3: #ffe2ee;
        --card: rgba(255, 255, 255, 0.93);
        --ink: #2b1a1f;
        --muted: #7b4e59;
        --accent: #ff5c7a;
        --accent-2: #ff9b6b;
        --accent-3: #ffd36d;
        --accent-4: #ffc6d9;
        --shadow: 0 26px 60px rgba(120, 52, 64, 0.2);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 20% 20%, var(--bg-1), transparent 45%),
          radial-gradient(circle at 80% 10%, var(--bg-3), transparent 45%),
          linear-gradient(140deg, var(--bg-2), var(--bg-1));
        color: var(--ink);
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px 16px 48px;
        overflow-x: hidden;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: radial-gradient(rgba(255, 255, 255, 0.35) 1px, transparent 1px);
        background-size: 22px 22px;
        opacity: 0.35;
        pointer-events: none;
      }

      .float-hearts {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 0;
      }

      .float-heart {
        position: absolute;
        bottom: -20px;
        animation: floatUp var(--dur) linear infinite;
        animation-delay: var(--delay);
        opacity: 0.65;
        filter: blur(0.2px);
      }

      @keyframes floatUp {
        0% {
          transform: translateY(0) scale(0.8) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 0.7;
        }
        100% {
          transform: translateY(-120vh) scale(1.2) rotate(12deg);
          opacity: 0;
        }
      }

      .app {
        width: min(92vw, 560px);
        position: relative;
        z-index: 1;
      }

      .progress-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .progress-text {
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-weight: 700;
        letter-spacing: 0.5px;
        font-size: 0.95rem;
        white-space: nowrap;
      }

      .progress-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 999px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 92, 122, 0.15);
      }

      .progress-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        border-radius: inherit;
        transition: width 0.35s ease;
        position: relative;
        overflow: hidden;
      }

      .progress-fill::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transform: translateX(-100%);
        animation: shimmer 2.6s ease-in-out infinite;
      }

      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }

      .card {
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.98), rgba(255, 244, 248, 0.95));
        border-radius: 26px;
        padding: 28px 26px;
        min-height: 420px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 92, 122, 0.12);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.65);
        pointer-events: none;
      }

      .card > * {
        position: relative;
        z-index: 1;
      }

      .card.animate-in {
        animation: cardIn 0.45s ease;
      }

      @keyframes cardIn {
        from {
          opacity: 0;
          transform: translateY(14px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      h1,
      h2,
      h3 {
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        margin: 0 0 12px;
      }

      p {
        margin: 0 0 14px;
        line-height: 1.55;
      }

      .muted {
        color: var(--muted);
      }

      .hidden {
        display: none;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 13px 18px;
        border-radius: 14px;
        border: none;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        --scale: 1;
        transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        touch-action: manipulation;
      }

      .btn.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff;
        box-shadow: 0 12px 22px rgba(255, 92, 122, 0.35);
      }

      .btn.secondary {
        background: #fff;
        color: var(--ink);
        border: 1px solid rgba(255, 92, 122, 0.3);
      }

      .btn:hover {
        transform: translateY(-1px) scale(var(--scale, 1));
      }

      .btn.primary:hover {
        box-shadow: 0 14px 26px rgba(255, 92, 122, 0.42);
      }

      .btn:active {
        transform: translateY(1px) scale(calc(var(--scale, 1) * 0.99));
      }

      .btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn.block {
        width: 100%;
      }

      .btn.pulse {
        animation: pulse 2.4s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(var(--scale, 1));
        }
        50% {
          transform: scale(calc(var(--scale, 1) * 1.03));
        }
      }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 10px;
      }

      button:focus-visible,
      .text-input:focus-visible {
        outline: 3px solid rgba(255, 92, 122, 0.45);
        outline-offset: 2px;
      }

      .burst-layer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 2;
      }

      .burst-heart {
        position: absolute;
        left: 50%;
        top: 50%;
        font-size: 22px;
        transform: translate(-50%, -50%);
        animation: burst 1.5s ease-out forwards;
        --dx: 0px;
        --dy: 0px;
        --rot: 0deg;
      }

      .pop-heart {
        position: absolute;
        font-size: 16px;
        transform: translate(-50%, -50%);
        animation: pop 0.9s ease-out forwards;
        --dx: 0px;
        --dy: 0px;
        pointer-events: none;
      }

      @keyframes burst {
        0% {
          transform: translate(-50%, -50%) scale(0.8) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy)))
            scale(1.4) rotate(var(--rot));
          opacity: 0;
        }
      }

      @keyframes pop {
        0% {
          transform: translate(-50%, -50%) scale(0.6);
          opacity: 1;
        }
        100% {
          transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2);
          opacity: 0;
        }
      }

      .mini-meter {
        height: 8px;
        background: rgba(255, 255, 255, 0.75);
        border-radius: 999px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 92, 122, 0.15);
        margin: 12px 0 6px;
      }

      .mini-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-3));
        border-radius: inherit;
        transition: width 0.5s ease;
      }

      .test-meta {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--muted);
      }

      .options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        margin-top: 12px;
        margin-bottom: 12px;
      }

      .options .btn {
        font-weight: 600;
        font-size: 0.95rem;
      }

      .reaction {
        background: rgba(255, 156, 130, 0.15);
        border-radius: 14px;
        padding: 12px 14px;
        margin-top: 10px;
      }

      .arena {
        height: 240px;
        border-radius: 20px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(255, 222, 230, 0.6));
        border: 1px dashed rgba(255, 92, 122, 0.25);
        position: relative;
        overflow: hidden;
      }

      .runner-heart {
        position: absolute;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: #fff;
        box-shadow: 0 10px 18px rgba(255, 92, 122, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        cursor: pointer;
        transition: transform 0.15s ease;
      }

      .runner-heart.caught {
        opacity: 0.45;
        cursor: default;
      }

      .reason-popup {
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: 16px;
        background: rgba(255, 214, 186, 0.55);
        opacity: 0;
        transform: translateY(6px) scale(0.98);
        transition: opacity 0.25s ease, transform 0.25s ease;
        min-height: 64px;
      }

      .reason-popup.show {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      .think-zone {
        margin-top: 10px;
        height: 140px;
        border-radius: 18px;
        background: rgba(255, 235, 244, 0.6);
        border: 1px dashed rgba(255, 92, 122, 0.35);
        position: relative;
        overflow: hidden;
      }

      .dodge-btn {
        position: absolute;
        left: 12px;
        top: 12px;
        transition: left 0.18s ease, top 0.18s ease, transform 0.15s ease;
      }

      .think-note {
        margin-top: 8px;
        font-size: 0.92rem;
        font-weight: 600;
        color: var(--muted);
      }

      .contract-list {
        display: grid;
        gap: 10px;
        margin: 12px 0 8px;
      }

      .contract-item {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        font-size: 0.95rem;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 233, 226, 0.5);
      }

      .contract-item input {
        margin-top: 2px;
        accent-color: var(--accent);
      }

      .doc-scroll {
        max-height: 240px;
        overflow-y: auto;
        padding: 14px 16px;
        background: rgba(255, 246, 249, 0.7);
        border-radius: 18px;
        border: 1px solid rgba(255, 92, 122, 0.2);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
      }

      .doc-scroll h3 {
        margin-top: 0;
        font-size: 1.05rem;
      }

      .doc-scroll ul {
        margin: 8px 0 12px 18px;
        padding: 0;
      }

      .doc-scroll li {
        margin-bottom: 6px;
      }

      .doc-checks .contract-item {
        background: rgba(255, 229, 236, 0.55);
      }

      .text-input {
        flex: 1;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 92, 122, 0.3);
        font-size: 1rem;
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        background: rgba(255, 255, 255, 0.95);
      }

      .hint {
        color: var(--accent);
        font-weight: 600;
        min-height: 22px;
      }

      .signature {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(255, 206, 120, 0.2);
        font-weight: 700;
      }

      .secret-boxes {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      .secret-box {
        background: rgba(255, 214, 224, 0.45);
        border-radius: 14px;
        padding: 12px 14px;
        font-weight: 600;
      }

      .small-note {
        margin-top: 18px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .finale {
        margin-top: 16px;
        padding: 14px 16px;
        border-radius: 16px;
        background: rgba(255, 214, 224, 0.4);
        border: 1px solid rgba(255, 92, 122, 0.18);
      }

      .finale h3 {
        margin-top: 0;
      }

      .tap-heart {
        position: fixed;
        z-index: 3;
        pointer-events: none;
        font-size: 18px;
        animation: tapFloat 0.8s ease-out forwards;
      }

      @keyframes tapFloat {
        0% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 0.9;
        }
        100% {
          transform: translate(-50%, -90%) scale(1.4);
          opacity: 0;
        }
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(26, 18, 22, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 4;
        padding: 24px;
      }

      .overlay.show {
        opacity: 1;
        pointer-events: auto;
      }

      .modal {
        background: #fff;
        border-radius: 20px;
        padding: 26px 24px;
        max-width: 420px;
        width: 100%;
        text-align: center;
        box-shadow: 0 18px 40px rgba(45, 20, 28, 0.35);
      }

      .confetti {
        position: fixed;
        top: -20px;
        animation: confettiFall var(--dur) ease-in forwards;
        z-index: 5;
        pointer-events: none;
        --rot: 0deg;
      }

      @keyframes confettiFall {
        0% {
          transform: translateY(-20px) rotate(var(--rot));
          opacity: 1;
        }
        100% {
          transform: translateY(110vh) rotate(calc(var(--rot) + 260deg));
          opacity: 0;
        }
      }

      @media (max-width: 520px) {
        .card {
          padding: 22px 18px;
          min-height: 400px;
        }

        .options {
          grid-template-columns: 1fr;
        }

        .btn-row {
          flex-direction: column;
        }

        .think-zone {
          height: 160px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="float-hearts" id="floatHearts" aria-hidden="true"></div>
    <main class="app" aria-live="polite">
      <div class="progress-row">
        <div class="progress-text" id="progressText">Шаг 1 / 7</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <section class="card" id="card"></section>
    </main>
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <script>
      const state = {
        step: 1,
        testIndex: 0,
        heartsCaught: 0,
        thinkClicks: 0,
        contractChecks: [false, false, false, false, false],
        contractSigned: false,
        secretUnlocked: false,
        signatureText: "",
        signatureDate: "",
        cleanups: [],
        audioCtx: null,
      };

      const totalSteps = 7;
      const card = document.getElementById("card");
      const progressText = document.getElementById("progressText");
      const progressFill = document.getElementById("progressFill");
      const overlay = document.getElementById("overlay");
      const floatHearts = document.getElementById("floatHearts");
      const loveSymbols = ["💖", "💗", "💘", "💞", "❤️", "✨"];

      const testQuestions = [
        {
          q: "Что в тебе самое классное?",
          options: ["Улыбка", "Глаза", "Характер", "Всё сразу"],
          reaction: "Правильно. Я проверял много раз — и каждый раз влюблялся сильнее.",
        },
        {
          q: "Когда ты запускаешь «наебательный процесс», я…",
          options: [
            "Сдаюсь",
            "Начинаю смеяться",
            "Понимаю, что это любовь",
            "Включаю режим: «Я всё вижу 😌»",
          ],
          reaction:
            "Наебательный процесс зафиксирован. Уровень хитрости: очаровательно опасный. Я сдаюсь с улыбкой.",
        },
        {
          q: "Что я люблю в тебе «слишком сильно» (и это странно)?",
          options: ["Смех", "Обнимашки", "Твою правую руку 🤝", "Всё перечисленное"],
          reaction: "Да, я знаю. Это странно. Но правая рука — легенда и мой VIP.",
        },
        {
          q: "Какой режим включается, когда ты рядом?",
          options: ["Счастье", "Режим «обнять»", "Сердце в танце", "Всё вместе"],
          reaction: "Все варианты — правда. Ты мой любимый режим.",
        },
        {
          q: "Самый честный факт про нас?",
          options: ["Ты мой дом", "С тобой спокойно", "Я хочу быть рядом всегда", "Все варианты"],
          reaction: "Верно. Это и есть любовь — спокойно, смешно и очень‑очень рядом.",
        },
      ];

      const heartReasons = [
        "Ты — мой уют. С тобой всё становится проще и теплее.",
        "Ты смешная. Опасно смешная — я влюбляюсь снова.",
        "Твой «наебательный процесс» — моё любимое шоу. Я всегда ‘против’, но внутри фанат и зритель в первом ряду.",
        "Ты умеешь быть милой даже когда делаешь вид, что серьёзная. Это моё слабое место.",
        "И да… твоя правая рука — отдельная любовь. Она уже в моём сердце.",
      ];

      const personNames = {
        her: "Иващенко Мария Александровна",
        him: "Чикобава Иракли Леванович",
      };

      const agreementContent = {
        title: "СОГЛАШЕНИЕ О ЛЮБВИ И ВАЛЕНТИНКЕ №14/02",
        paragraphs: [
          "Настоящий документ создан в одном экземпляре сердца, но действует в двух сердцах — моем и Машином.",
          `Стороны соглашения: ${personNames.her} (далее «Маша», «бусинка») и ${personNames.him} (далее «Иракли», «влюбленный»).`,
          "Предмет соглашения: добровольное согласие Маши быть моей валентинкой, принимать заботу, мемы, сюрпризы и бесконечные обнимашки.",
          "Срок действия: бессрочно, с автоматическим продлением на каждую улыбку, взгляд и «ты моя милая».",
          "Особое условие: фраза «я еще подумаю» считается милым флиртом и после 20 нажатий превращается в «да».",
          "Документ составлен с любовью, добрым юмором и нежностью.",
        ],
        bullets: [
          "Обнимашки могут приходить без предупреждения, но всегда с нежностью.",
          "Мемы допускаются в неожиданные моменты и считаются поводом улыбнуться.",
          "«Наебательный процесс» разрешён строго в милых целях.",
          "Титул «бусинка» является постоянным и оспариванию не подлежит.",
          "Правая рука Маши находится под особой защитой и вниманием.",
        ],
        closing: `Подписывая документ, Маша подтверждает, что выбирает любовь, смех и ${personNames.him} на роль официальной валентинки и главного обнимателя.`,
      };

      function addCleanup(fn) {
        state.cleanups.push(fn);
      }

      function runCleanups() {
        while (state.cleanups.length) {
          const fn = state.cleanups.pop();
          try {
            fn();
          } catch (error) {
            console.error(error);
          }
        }
      }

      function beep(freq = 640, duration = 0.08) {
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if (!AudioContext) return;
          if (!state.audioCtx) state.audioCtx = new AudioContext();
          const ctx = state.audioCtx;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          gain.gain.value = 0.05;
          osc.frequency.value = freq;
          osc.type = "triangle";
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start();
          osc.stop(ctx.currentTime + duration);
        } catch (error) {
          console.warn(error);
        }
      }

      function updateProgress() {
        progressText.textContent = `Шаг ${state.step} / ${totalSteps}`;
        progressFill.style.width = `${(state.step / totalSteps) * 100}%`;
      }

      function animateCard() {
        card.classList.remove("animate-in");
        void card.offsetWidth;
        card.classList.add("animate-in");
      }

      function focusPrimary() {
        const btn = card.querySelector(".btn.primary:not([disabled])") || card.querySelector("button");
        if (btn) setTimeout(() => btn.focus(), 60);
      }

      function burstHearts(container, amount = 18) {
        for (let i = 0; i < amount; i++) {
          const heart = document.createElement("span");
          heart.className = "burst-heart";
          heart.textContent = loveSymbols[Math.floor(Math.random() * loveSymbols.length)];
          const angle = Math.random() * Math.PI * 2;
          const distance = 40 + Math.random() * 120;
          heart.style.setProperty("--dx", `${Math.cos(angle) * distance}px`);
          heart.style.setProperty("--dy", `${Math.sin(angle) * distance}px`);
          heart.style.setProperty("--rot", `${Math.random() * 140 - 70}deg`);
          container.appendChild(heart);
          setTimeout(() => heart.remove(), 1600);
        }
      }

      function popHeartsAt(container, x, y, amount = 8) {
        for (let i = 0; i < amount; i++) {
          const heart = document.createElement("span");
          heart.className = "pop-heart";
          heart.textContent = loveSymbols[Math.floor(Math.random() * loveSymbols.length)];
          const angle = Math.random() * Math.PI * 2;
          const distance = 14 + Math.random() * 34;
          heart.style.left = `${x}px`;
          heart.style.top = `${y}px`;
          heart.style.setProperty("--dx", `${Math.cos(angle) * distance}px`);
          heart.style.setProperty("--dy", `${Math.sin(angle) * distance}px`);
          container.appendChild(heart);
          setTimeout(() => heart.remove(), 900);
        }
      }

      function initFloatingHearts() {
        if (!floatHearts) return;
        const amount = 18;
        for (let i = 0; i < amount; i++) {
          const heart = document.createElement("span");
          heart.className = "float-heart";
          heart.textContent = loveSymbols[Math.floor(Math.random() * (loveSymbols.length - 1))];
          heart.style.left = `${Math.random() * 100}%`;
          heart.style.fontSize = `${14 + Math.random() * 18}px`;
          heart.style.setProperty("--dur", `${8 + Math.random() * 6}s`);
          heart.style.setProperty("--delay", `${-Math.random() * 8}s`);
          heart.style.opacity = `${0.35 + Math.random() * 0.4}`;
          floatHearts.appendChild(heart);
        }
      }

      function createTapHeart(x, y) {
        const heart = document.createElement("span");
        heart.className = "tap-heart";
        heart.textContent = loveSymbols[Math.floor(Math.random() * loveSymbols.length)];
        heart.style.left = `${x}px`;
        heart.style.top = `${y}px`;
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 800);
      }

      function setupTapHearts() {
        document.addEventListener("click", (event) => {
          if (!event.target.closest(".btn")) return;
          createTapHeart(event.clientX, event.clientY);
        });
      }

      function buildAgreementHtml() {
        const paragraphs = agreementContent.paragraphs
          .map((text) => `<p>${text}</p>`)
          .join("");
        const bullets = agreementContent.bullets.map((text) => `<li>${text}</li>`).join("");
        return `
          <h3 class="doc-title">${agreementContent.title}</h3>
          ${paragraphs}
          <ul>${bullets}</ul>
          <p>${agreementContent.closing}</p>
        `;
      }

      function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        if (!text) return y + lineHeight * 0.6;
        const words = text.split(" ");
        let line = "";
        for (let i = 0; i < words.length; i++) {
          const testLine = `${line}${words[i]} `;
          if (ctx.measureText(testLine).width > maxWidth && line) {
            ctx.fillText(line.trim(), x, y);
            line = `${words[i]} `;
            y += lineHeight;
          } else {
            line = testLine;
          }
        }
        if (line) {
          ctx.fillText(line.trim(), x, y);
          y += lineHeight;
        }
        return y;
      }

      function base64ToUint8Array(base64) {
        const raw = atob(base64);
        const bytes = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; i++) {
          bytes[i] = raw.charCodeAt(i);
        }
        return bytes;
      }

      function buildPdfBlob(jpegBytes, width, height) {
        const encoder = new TextEncoder();
        const parts = [];
        const offsets = [0];
        let length = 0;

        function pushBytes(bytes) {
          parts.push(bytes);
          length += bytes.length;
        }

        function pushText(text) {
          const bytes = encoder.encode(text);
          pushBytes(bytes);
        }

        function markOffset() {
          offsets.push(length);
        }

        function padOffset(value) {
          return String(value).padStart(10, "0");
        }

        pushText("%PDF-1.3\n");

        markOffset();
        pushText("1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n");

        markOffset();
        pushText("2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n");

        markOffset();
        pushText(
          `3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${width} ${height}] ` +
            `/Resources << /XObject << /Im0 4 0 R >> /ProcSet [/PDF /ImageC] >> ` +
            `/Contents 5 0 R >>\nendobj\n`
        );

        markOffset();
        pushText(
          `4 0 obj\n<< /Type /XObject /Subtype /Image /Width ${width} /Height ${height} ` +
            `/ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${jpegBytes.length} >>\nstream\n`
        );
        pushBytes(jpegBytes);
        pushText("\nendstream\nendobj\n");

        const contentStream = `q\n${width} 0 0 ${height} 0 0 cm\n/Im0 Do\nQ\n`;
        markOffset();
        pushText(
          `5 0 obj\n<< /Length ${contentStream.length} >>\nstream\n${contentStream}endstream\nendobj\n`
        );

        const xrefOffset = length;
        pushText("xref\n0 6\n");
        pushText("0000000000 65535 f \n");
        for (let i = 1; i < offsets.length; i++) {
          pushText(`${padOffset(offsets[i])} 00000 n \n`);
        }

        pushText(`trailer\n<< /Size 6 /Root 1 0 R >>\nstartxref\n${xrefOffset}\n%%EOF`);

        return new Blob(parts, { type: "application/pdf" });
      }

      function buildAgreementPdf(signatureLine, dateLine) {
        const width = 595;
        const height = 842;
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = "#2b1a1f";
        ctx.textBaseline = "top";

        let y = 40;
        ctx.font = "bold 18px \"Times New Roman\", serif";
        y = wrapText(ctx, agreementContent.title, 40, y, width - 80, 24) + 6;
        ctx.font = "14px \"Times New Roman\", serif";

        agreementContent.paragraphs.forEach((paragraph) => {
          y = wrapText(ctx, paragraph, 40, y, width - 80, 20) + 2;
        });

        y += 6;
        ctx.font = "bold 14px \"Times New Roman\", serif";
        y = wrapText(ctx, "Основные условия:", 40, y, width - 80, 20);
        ctx.font = "14px \"Times New Roman\", serif";
        agreementContent.bullets.forEach((bullet) => {
          y = wrapText(ctx, `• ${bullet}`, 50, y, width - 90, 20);
        });

        y += 6;
        y = wrapText(ctx, agreementContent.closing, 40, y, width - 80, 20);

        if (signatureLine) {
          y += 10;
          ctx.font = "bold 14px \"Times New Roman\", serif";
          y = wrapText(ctx, signatureLine, 40, y, width - 80, 20);
          ctx.font = "12px \"Times New Roman\", serif";
          if (dateLine) {
            y = wrapText(ctx, dateLine, 40, y, width - 80, 18);
          }
        }

        const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
        const jpegBytes = base64ToUint8Array(dataUrl.split(",")[1]);
        return buildPdfBlob(jpegBytes, width, height);
      }

      function downloadAgreementPdf(signatureLine, dateLine) {
        const blob = buildAgreementPdf(signatureLine, dateLine);
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "love_day_agreement.pdf";
        document.body.appendChild(link);
        link.click();
        link.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      function showOverlay(title, text) {
        overlay.innerHTML = `
          <div class="modal">
            <h2>${title}</h2>
            <p>${text}</p>
            <button class="btn primary" id="closeOverlay" type="button">Обнять ❤️</button>
          </div>
        `;
        overlay.classList.add("show");
        overlay.setAttribute("aria-hidden", "false");
        const closeBtn = document.getElementById("closeOverlay");
        closeBtn.addEventListener("click", () => {
          overlay.classList.remove("show");
          overlay.setAttribute("aria-hidden", "true");
          closeBtn.blur();
        });
      }

      const steps = {
        1: {
          template: () => `
            <h1>Маша, система сердца перегрелась от милоты 💥</h1>
            <p id="loadingLine">Идёт загрузка чувств…</p>
            <p id="loadingSub" class="muted">Запускаю протокол «любовь»…</p>
            <div class="mini-meter">
              <div class="mini-fill" id="loadingFill"></div>
            </div>
            <p id="errorLine" class="muted hidden">Ошибка: уровень «бусинка» превышает допустимый. Сердце переполнено любовью ❤️</p>
            <div class="burst-layer" id="burstLayer" aria-hidden="true"></div>
            <div class="btn-row">
              <button class="btn primary pulse" id="restartBtn" type="button" disabled>Перезапустить сердечко для Маши ❤️</button>
            </div>
          `,
          init: () => {
            const loadingLine = document.getElementById("loadingLine");
            const loadingSub = document.getElementById("loadingSub");
            const loadingFill = document.getElementById("loadingFill");
            const errorLine = document.getElementById("errorLine");
            const restartBtn = document.getElementById("restartBtn");
            const burstLayer = document.getElementById("burstLayer");
            const stages = [
              { line: "Идёт загрузка чувств…", sub: "Запускаю протокол «любовь»", percent: 12, delay: 0 },
              { line: "Сканирую улыбку Маши…", sub: "Нежность растёт", percent: 24, delay: 900 },
              { line: "Подкачиваю обнимашки…", sub: "Сердце ускорилось", percent: 39, delay: 900 },
              { line: "Заливаю смех и тепло…", sub: "Мне так хорошо рядом с тобой", percent: 57, delay: 900 },
              { line: "Любовь переполняет систему…", sub: "Маша = абсолютная милота", percent: 78, delay: 900 },
              { line: "Финальная проверка…", sub: "Предел близко", percent: 93, delay: 900 },
            ];

            let totalDelay = 0;

            function applyStage(stage) {
              loadingLine.textContent = `${stage.line} ${stage.percent}%`;
              loadingSub.textContent = stage.sub;
              loadingFill.style.width = `${stage.percent}%`;
            }

            stages.forEach((stage) => {
              totalDelay += stage.delay;
              const timer = setTimeout(() => applyStage(stage), totalDelay);
              addCleanup(() => clearTimeout(timer));
            });

            const boomTimer = setTimeout(() => {
              errorLine.classList.remove("hidden");
              burstHearts(burstLayer, 26);
              loadingFill.style.width = "100%";
              restartBtn.disabled = false;
              beep(520);
              focusPrimary();
            }, totalDelay + 900);

            addCleanup(() => clearTimeout(boomTimer));
            restartBtn.addEventListener("click", () => {
              beep(680);
              nextStep();
            });
          },
        },
        2: {
          template: () => `
            <h2>Мини‑тест на легендарность Маши</h2>
            <p class="muted">Никаких неправильных ответов — ты прекрасна в любом варианте.</p>
            <div class="test-meta" id="testMeta"></div>
            <h3 id="testQuestion"></h3>
            <div class="options" id="testOptions"></div>
            <div class="reaction hidden" id="testReaction"></div>
            <div class="btn-row">
              <button class="btn primary hidden" id="testNext" type="button">Следующий вопрос</button>
              <button class="btn primary pulse hidden" id="testDone" type="button">Дальше</button>
            </div>
          `,
          init: () => {
            state.testIndex = 0;
            const testMeta = document.getElementById("testMeta");
            const testQuestion = document.getElementById("testQuestion");
            const testOptions = document.getElementById("testOptions");
            const testReaction = document.getElementById("testReaction");
            const nextBtn = document.getElementById("testNext");
            const doneBtn = document.getElementById("testDone");

            function renderQuestion() {
              const current = testQuestions[state.testIndex];
              testMeta.textContent = `Вопрос ${state.testIndex + 1} / ${testQuestions.length}`;
              testQuestion.textContent = current.q;
              testOptions.innerHTML = "";
              testReaction.classList.add("hidden");
              nextBtn.classList.add("hidden");
              doneBtn.classList.add("hidden");

              current.options.forEach((option) => {
                const btn = document.createElement("button");
                btn.className = "btn secondary";
                btn.type = "button";
                btn.textContent = option;
                btn.addEventListener("click", () => {
                  testReaction.textContent = current.reaction;
                  testReaction.classList.remove("hidden");
                  [...testOptions.querySelectorAll("button")].forEach((b) => (b.disabled = true));
                  beep(720);
                  if (state.testIndex < testQuestions.length - 1) {
                    nextBtn.classList.remove("hidden");
                  } else {
                    doneBtn.classList.remove("hidden");
                  }
                  focusPrimary();
                });
                testOptions.appendChild(btn);
              });
            }

            nextBtn.addEventListener("click", () => {
              state.testIndex += 1;
              renderQuestion();
              focusPrimary();
            });
            doneBtn.addEventListener("click", () => {
              beep(660);
              nextStep();
            });

            renderQuestion();
            focusPrimary();
          },
        },
        3: {
          template: () => `
            <h2>Поймай 5 сердечек</h2>
            <p class="muted">Каждое сердечко открывает причину, почему я тебя люблю.</p>
            <div class="test-meta">Причины: <span id="catchCount">0/5</span></div>
            <div class="arena" id="heartArena">
              <button class="runner-heart" id="runnerHeart" type="button" aria-label="Поймать сердечко">❤️</button>
            </div>
            <div class="reason-popup" id="reasonPopup"></div>
            <div class="btn-row">
              <button class="btn primary pulse hidden" id="toContract" type="button">К договору ❤️</button>
            </div>
          `,
          init: () => {
            state.heartsCaught = 0;
            const arena = document.getElementById("heartArena");
            const heart = document.getElementById("runnerHeart");
            const countEl = document.getElementById("catchCount");
            const reasonPopup = document.getElementById("reasonPopup");
            const toContract = document.getElementById("toContract");
            const size = 56;
            let rafId = null;
            let pointer = { x: null, y: null };
            let bounds = arena.getBoundingClientRect();
            let pos = {
              x: (bounds.width - size) / 2,
              y: (bounds.height - size) / 2,
            };
            let vel = { x: 2.2, y: 1.7 };

            function updateBounds() {
              bounds = arena.getBoundingClientRect();
            }

            function onMove(event) {
              const rect = arena.getBoundingClientRect();
              pointer.x = event.clientX - rect.left;
              pointer.y = event.clientY - rect.top;
            }

            function onTouch(event) {
              const touch = event.touches[0];
              if (!touch) return;
              const rect = arena.getBoundingClientRect();
              pointer.x = touch.clientX - rect.left;
              pointer.y = touch.clientY - rect.top;
            }

            function tick() {
              if (pointer.x !== null && pointer.y !== null) {
                const dx = pos.x + size / 2 - pointer.x;
                const dy = pos.y + size / 2 - pointer.y;
                const distance = Math.hypot(dx, dy);
                if (distance < 120) {
                  const push = (120 - distance) / 120;
                  vel.x += (dx / (distance || 1)) * push * 1.6;
                  vel.y += (dy / (distance || 1)) * push * 1.6;
                }
              }

              if (Math.random() < 0.04) {
                vel.x += (Math.random() - 0.5) * 1.4;
                vel.y += (Math.random() - 0.5) * 1.4;
              }

              vel.x *= 0.97;
              vel.y *= 0.97;
              pos.x += vel.x;
              pos.y += vel.y;

              if (pos.x < 0) {
                pos.x = 0;
                vel.x = Math.abs(vel.x);
              } else if (pos.x > bounds.width - size) {
                pos.x = bounds.width - size;
                vel.x = -Math.abs(vel.x);
              }
              if (pos.y < 0) {
                pos.y = 0;
                vel.y = Math.abs(vel.y);
              } else if (pos.y > bounds.height - size) {
                pos.y = bounds.height - size;
                vel.y = -Math.abs(vel.y);
              }

              heart.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
              rafId = requestAnimationFrame(tick);
            }

            function showReason(index) {
              reasonPopup.innerHTML = `<strong>Причина №${index}</strong><div>${heartReasons[index - 1]}</div>`;
              reasonPopup.classList.remove("show");
              void reasonPopup.offsetWidth;
              reasonPopup.classList.add("show");
            }

            function randomJump() {
              pos.x = Math.random() * (bounds.width - size);
              pos.y = Math.random() * (bounds.height - size);
              vel.x = (Math.random() - 0.5) * 6;
              vel.y = (Math.random() - 0.5) * 6;
            }

            heart.addEventListener("click", () => {
              if (state.heartsCaught >= 5) return;
              state.heartsCaught += 1;
              countEl.textContent = `${state.heartsCaught}/5`;
              showReason(state.heartsCaught);
              popHeartsAt(arena, pos.x + size / 2, pos.y + size / 2, 10);
              beep(780);
              if (state.heartsCaught >= 5) {
                heart.classList.add("caught");
                toContract.classList.remove("hidden");
                popHeartsAt(arena, bounds.width / 2, bounds.height / 2, 16);
                cancelAnimationFrame(rafId);
              } else {
                randomJump();
              }
              focusPrimary();
            });

            toContract.addEventListener("click", () => {
              beep(640);
              nextStep();
            });

            arena.addEventListener("mousemove", onMove);
            arena.addEventListener("touchmove", onTouch, { passive: true });
            window.addEventListener("resize", updateBounds);
            updateBounds();
            rafId = requestAnimationFrame(tick);

            addCleanup(() => cancelAnimationFrame(rafId));
            addCleanup(() => arena.removeEventListener("mousemove", onMove));
            addCleanup(() => arena.removeEventListener("touchmove", onTouch));
            addCleanup(() => window.removeEventListener("resize", updateBounds));
          },
        },
        4: {
          template: () => `
            <h2>ДОГОВОР №14/02: «Маша — моя валентинка»</h2>
            <p class="muted">Поставь галочки. Юристы сердца строгие, но добрые.</p>
            <div class="contract-list" id="contractList">
              <label class="contract-item"><input type="checkbox" data-index="0" />Согласна получать обнимашки без предупреждения</label>
              <label class="contract-item"><input type="checkbox" data-index="1" />Согласна на мемы в неожиданные моменты</label>
              <label class="contract-item"><input type="checkbox" data-index="2" />Согласна иногда запускать «наебательный процесс» (в разумных пределах)</label>
              <label class="contract-item"><input type="checkbox" data-index="3" />Согласна, что ты бусинка (не оспаривается)</label>
              <label class="contract-item"><input type="checkbox" data-index="4" />Согласна, что правая рука — под особой защитой и вниманием 😄</label>
            </div>
            <div class="hint" id="contractHint"></div>
            <div class="btn-row">
              <button class="btn primary pulse" id="signBtn" type="button" disabled>Подписать, бусинка ❤️</button>
              <button class="btn primary pulse hidden" id="toSecret" type="button">Дальше</button>
            </div>
            <div class="signature hidden" id="signature">Подписано: Маша ✅ Статус: официальная валентинка (уровень: легендарный). Любовь подтверждена.</div>
          `,
          init: () => {
            state.contractChecks = [false, false, false, false, false];
            state.contractSigned = false;
            const list = document.getElementById("contractList");
            const signBtn = document.getElementById("signBtn");
            const hint = document.getElementById("contractHint");
            const signature = document.getElementById("signature");
            const toSecret = document.getElementById("toSecret");
            const minChecks = 4;

            function updateState() {
              const count = [...list.querySelectorAll("input[type='checkbox']")].filter(
                (input) => input.checked
              ).length;
              signBtn.disabled = count < minChecks;
              hint.textContent =
                count < minChecks
                  ? "Маловато милоты в форме. Добавь ещё одну галочку, милая."
                  : "";
            }

            list.addEventListener("change", updateState);

            signBtn.addEventListener("click", () => {
              if (signBtn.disabled) return;
              beep(700);
              state.contractSigned = true;
              signature.classList.remove("hidden");
              toSecret.classList.remove("hidden");
              signBtn.disabled = true;
              [...list.querySelectorAll("input")].forEach((input) => (input.disabled = true));
              hint.textContent = "";
              focusPrimary();
            });

            toSecret.addEventListener("click", () => {
              beep(640);
              nextStep();
            });

            updateState();
          },
        },
        5: {
          template: () => `
            <h2>Секретная комната 🔒</h2>
            <p class="muted">Только для Маши. Подсказка: пароль — то, что мы часто говорим. Подсказка 2: это про процесс 😌</p>
            <div class="btn-row">
              <input id="secretInput" class="text-input" type="text" placeholder="Пароль для бусинки" aria-label="Пароль" />
              <button class="btn primary" id="secretBtn" type="button">Открыть</button>
            </div>
            <div class="hint" id="secretHint"></div>
            <div class="secret-boxes hidden" id="secretBoxes">
              <div class="secret-box">Ты моя милая. Я горжусь тобой каждый день.</div>
              <div class="secret-box">Я выбираю тебя. Каждый день. Всегда.</div>
              <div class="secret-box">PS: правая рука получает VIP-пропуск на обнимашки.</div>
            </div>
            <div class="btn-row">
              <button class="btn primary pulse hidden" id="toFinal" type="button">К финалу 💘</button>
            </div>
          `,
          init: () => {
            state.secretUnlocked = false;
            const input = document.getElementById("secretInput");
            const btn = document.getElementById("secretBtn");
            const hint = document.getElementById("secretHint");
            const boxes = document.getElementById("secretBoxes");
            const toFinal = document.getElementById("toFinal");

            function unlock() {
              const value = input.value.trim().toLowerCase();
              if (value === "наебательный процесс") {
                state.secretUnlocked = true;
                boxes.classList.remove("hidden");
                toFinal.classList.remove("hidden");
                hint.textContent = "Доступ открыт для бусинки ✅";
                beep(760);
                focusPrimary();
              } else {
                hint.textContent =
                  "Хм… это похоже на попытку обмана. Запускается «наебательный процесс»? 😄";
                beep(440);
              }
            }

            btn.addEventListener("click", unlock);
            input.addEventListener("keydown", (event) => {
              if (event.key === "Enter") unlock();
            });

            toFinal.addEventListener("click", () => {
              beep(640);
              nextStep();
            });
            focusPrimary();
          },
        },
        6: {
          template: () => `
            <h2>Маша, будешь моей валентинкой? 💘</h2>
            <p class="muted">Я хочу любить тебя, радовать, смешить и быть рядом каждый день.</p>
            <div class="btn-row">
              <button class="btn primary" id="yesBtn" type="button">Да</button>
            </div>
            <div class="think-zone" id="thinkZone" aria-label="Поле для ловли мысли">
              <button class="btn secondary dodge-btn" id="thinkBtn" type="button">Я еще подумаю</button>
            </div>
            <div class="think-note" id="thinkNote">Поймать мысль: 0/20</div>
            <div class="small-note">Ответ «нет» временно недоступен по техническим причинам (потому что я люблю тебя).</div>
          `,
          init: () => {
            const yesBtn = document.getElementById("yesBtn");
            const thinkZone = document.getElementById("thinkZone");
            const thinkBtn = document.getElementById("thinkBtn");
            const thinkNote = document.getElementById("thinkNote");
            let autoAdvance = null;

            state.thinkClicks = 0;
            thinkNote.textContent = "Поймать мысль: 0/20";

            function setThinkPosition(x, y) {
              thinkBtn.style.left = `${x}px`;
              thinkBtn.style.top = `${y}px`;
            }

            function randomThinkPosition(avoidPoint) {
              const maxX = Math.max(0, thinkZone.clientWidth - thinkBtn.offsetWidth);
              const maxY = Math.max(0, thinkZone.clientHeight - thinkBtn.offsetHeight);
              let x = Math.random() * maxX;
              let y = Math.random() * maxY;

              if (avoidPoint) {
                for (let i = 0; i < 6; i++) {
                  const dx = x + thinkBtn.offsetWidth / 2 - avoidPoint.x;
                  const dy = y + thinkBtn.offsetHeight / 2 - avoidPoint.y;
                  if (Math.hypot(dx, dy) > 120) break;
                  x = Math.random() * maxX;
                  y = Math.random() * maxY;
                }
              }

              setThinkPosition(x, y);
            }

            function handleDodge(event) {
              if (state.thinkClicks >= 20) return;
              const rect = thinkZone.getBoundingClientRect();
              const pointerX = event.clientX - rect.left;
              const pointerY = event.clientY - rect.top;
              const btnRect = thinkBtn.getBoundingClientRect();
              const btnX = btnRect.left - rect.left + btnRect.width / 2;
              const btnY = btnRect.top - rect.top + btnRect.height / 2;
              const distance = Math.hypot(btnX - pointerX, btnY - pointerY);
              if (distance < 120) {
                randomThinkPosition({ x: pointerX, y: pointerY });
              }
            }

            function finishThink() {
              thinkNote.textContent = "Уговорила. Сердце сдалось ❤️";
              thinkBtn.disabled = true;
              burstHearts(thinkZone, 26);
              fireConfetti();
              autoAdvance = setTimeout(() => {
                nextStep();
              }, 1400);
            }

            yesBtn.addEventListener("click", () => {
              beep(820);
              nextStep();
            });

            thinkBtn.addEventListener("click", (event) => {
              if (state.thinkClicks >= 20) return;
              state.thinkClicks += 1;
              const scale = 1 + state.thinkClicks * 0.04;
              thinkBtn.style.setProperty("--scale", scale.toFixed(2));
              thinkNote.textContent = `Поймать мысль: ${state.thinkClicks}/20`;
              const rect = thinkZone.getBoundingClientRect();
              const clickX = event.clientX - rect.left;
              const clickY = event.clientY - rect.top;
              popHeartsAt(thinkZone, clickX, clickY, 8);
              beep(760);
              if (state.thinkClicks >= 20) {
                finishThink();
              } else {
                randomThinkPosition({ x: clickX, y: clickY });
              }
              focusPrimary();
            });

            thinkBtn.addEventListener("mouseenter", () => {
              if (state.thinkClicks >= 20) return;
              randomThinkPosition();
            });

            const touchHandler = (event) => {
              if (state.thinkClicks >= 20) return;
              const touch = event.touches[0];
              if (!touch) return;
              const rect = thinkZone.getBoundingClientRect();
              randomThinkPosition({ x: touch.clientX - rect.left, y: touch.clientY - rect.top });
            };

            thinkZone.addEventListener("mousemove", handleDodge);
            thinkZone.addEventListener("touchstart", touchHandler, { passive: true });

            const placeTimer = requestAnimationFrame(() => {
              thinkBtn.style.setProperty("--scale", "1");
              randomThinkPosition();
            });

            addCleanup(() => cancelAnimationFrame(placeTimer));
            addCleanup(() => thinkZone.removeEventListener("mousemove", handleDodge));
            addCleanup(() => thinkZone.removeEventListener("touchstart", touchHandler));
            addCleanup(() => clearTimeout(autoAdvance));
            focusPrimary();
          },
        },
        7: {
          template: () => `
            <h2>Большой документ любви</h2>
            <p class="muted">Прочитай и подтверди. Тут всё серьёзно и очень мило.</p>
            <div class="doc-scroll" id="docScroll">
              ${buildAgreementHtml()}
            </div>
            <div class="contract-list doc-checks" id="docChecks">
              <label class="contract-item"><input type="checkbox" data-doc="0" />Я внимательно прочитала и согласна</label>
              <label class="contract-item"><input type="checkbox" data-doc="1" />Я подтверждаю, что буду валентинкой Иракли</label>
              <label class="contract-item"><input type="checkbox" data-doc="2" />Я подтверждаю особую защиту правой руки 😄</label>
            </div>
            <div class="hint" id="docHint"></div>
            <div class="btn-row">
              <button class="btn primary pulse" id="docSignBtn" type="button" disabled>Подписать документ ❤️</button>
              <button class="btn secondary hidden" id="docPdfBtn" type="button">Скачать PDF</button>
            </div>
            <div class="signature hidden" id="docSignature"></div>
            <div class="finale hidden" id="finale">
              <h3>Финальный сюрприз</h3>
              <p>Теперь всё официально и очень-очень нежно. Хочешь запустить салют любви?</p>
              <div class="btn-row">
                <button class="btn primary" id="finaleBtn" type="button">Запустить салют любви</button>
              </div>
              <p class="small-note">Спасибо, что ты есть. Ты мой самый любимый финал.</p>
            </div>
            <div class="burst-layer" id="docBurst" aria-hidden="true"></div>
          `,
          init: () => {
            const docChecks = document.getElementById("docChecks");
            const docHint = document.getElementById("docHint");
            const signBtn = document.getElementById("docSignBtn");
            const pdfBtn = document.getElementById("docPdfBtn");
            const signature = document.getElementById("docSignature");
            const finale = document.getElementById("finale");
            const finaleBtn = document.getElementById("finaleBtn");
            const docBurst = document.getElementById("docBurst");
            const minChecks = 2;

            function updateDocState() {
              const count = [...docChecks.querySelectorAll("input[type='checkbox']")].filter(
                (input) => input.checked
              ).length;
              signBtn.disabled = count < minChecks;
              docHint.textContent =
                count < minChecks ? "Чтобы подписать, поставь ещё одну галочку, милая." : "";
            }

            signBtn.addEventListener("click", () => {
              if (signBtn.disabled) return;
              const dateStr = new Date().toLocaleDateString("ru-RU");
              state.signatureText = `Я, ${personNames.her}, подтверждаю согласие быть валентинкой ${personNames.him}.`;
              state.signatureDate = dateStr;
              signature.innerHTML = `<strong>Подтверждение:</strong> ${state.signatureText} Дата: ${dateStr}.`;
              signature.classList.remove("hidden");
              pdfBtn.classList.remove("hidden");
              finale.classList.remove("hidden");
              signBtn.disabled = true;
              [...docChecks.querySelectorAll("input")].forEach((input) => (input.disabled = true));
              docHint.textContent = "";
              burstHearts(docBurst, 24);
              fireConfetti();
              beep(760);
              focusPrimary();
            });

            pdfBtn.addEventListener("click", () => {
              const dateLine = state.signatureDate ? `Дата: ${state.signatureDate}.` : "";
              downloadAgreementPdf(state.signatureText, dateLine);
              beep(640);
            });

            finaleBtn.addEventListener("click", () => {
              fireConfetti();
              burstHearts(docBurst, 30);
              showOverlay("Салют любви!", "Спасибо, что ты моя валентинка. Я тебя люблю, Маша.");
            });

            docChecks.addEventListener("change", updateDocState);
            updateDocState();
            focusPrimary();
          },
        },
      };

      function renderStep() {
        runCleanups();
        updateProgress();
        card.innerHTML = steps[state.step].template();
        animateCard();
        steps[state.step].init();
      }

      function nextStep() {
        if (state.step < totalSteps) {
          state.step += 1;
          renderStep();
        }
      }

      function fireConfetti() {
        const amount = 36;
        for (let i = 0; i < amount; i++) {
          const confetti = document.createElement("span");
          confetti.className = "confetti";
          confetti.textContent = loveSymbols[Math.floor(Math.random() * loveSymbols.length)];
          confetti.style.left = `${Math.random() * 100}vw`;
          confetti.style.setProperty("--dur", `${2.6 + Math.random() * 1.6}s`);
          confetti.style.setProperty("--rot", `${Math.random() * 120 - 60}deg`);
          confetti.style.fontSize = `${14 + Math.random() * 18}px`;
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 4200);
        }
      }

      initFloatingHearts();
      setupTapHearts();
      renderStep();
    </script>
  </body>
</html>
